{% extends "base.html" %}

{% block title %}Mark Attendance - Student Attendance System{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-camera me-2"></i>Mark Attendance with Camera
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Camera View -->
                            <div class="text-center">
                                <video id="video" width="100%" height="400" autoplay style="border-radius: 10px; background-color: #f8f9fa;">
                                    Your browser does not support video streaming.
                                </video>
                                
                                <!-- Canvas for capturing images (hidden) -->
                                <canvas id="canvas" style="display: none;"></canvas>
                                
                                <!-- Camera Controls -->
                                <div class="mt-3">
                                    <button id="startCamera" class="btn btn-primary me-2">
                                        <i class="fas fa-play me-2"></i>Start Camera
                                    </button>
                                    <button id="captureBtn" class="btn btn-success me-2" disabled>
                                        <i class="fas fa-camera me-2"></i>Capture & Mark Attendance
                                    </button>
                                    <button id="stopCamera" class="btn btn-danger" disabled>
                                        <i class="fas fa-stop me-2"></i>Stop Camera
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- Status Panel -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>Status
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="statusMessage" class="alert alert-info">
                                        <i class="fas fa-info me-2"></i>Click "Start Camera" to begin
                                    </div>
                                    
                                    <!-- Recognition Results -->
                                    <div id="recognitionResults" style="display: none;">
                                        <h6><i class="fas fa-users me-2"></i>Recognized Students:</h6>
                                        <div id="resultsList"></div>
                                    </div>
                                    
                                    <!-- Instructions -->
                                    <div class="mt-3">
                                        <h6><i class="fas fa-lightbulb me-2"></i>Instructions:</h6>
                                        <ul class="small">
                                            <li>Ensure good lighting</li>
                                            <li>Look directly at the camera</li>
                                            <li>Remove sunglasses/masks</li>
                                            <li>One person at a time works best</li>
                                            <li>Wait for the capture to process</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Today's Attendance Summary -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-day me-2"></i>Today's Attendance Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3 class="text-primary" id="totalStudents">-</h3>
                            <p class="mb-0">Total Students</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-success" id="presentCount">-</h3>
                            <p class="mb-0">Present Today</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-warning" id="absentCount">-</h3>
                            <p class="mb-0">Absent</p>
                        </div>
                        <div class="col-md-3">
                            <h3 class="text-info" id="attendanceRate">-</h3>
                            <p class="mb-0">Attendance Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let context = canvas.getContext('2d');
let stream = null;

const startCameraBtn = document.getElementById('startCamera');
const captureBtn = document.getElementById('captureBtn');
const stopCameraBtn = document.getElementById('stopCamera');
const statusMessage = document.getElementById('statusMessage');
const recognitionResults = document.getElementById('recognitionResults');
const resultsList = document.getElementById('resultsList');

// Start Camera
startCameraBtn.addEventListener('click', async function() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 }
            } 
        });
        video.srcObject = stream;
        
        startCameraBtn.disabled = true;
        captureBtn.disabled = false;
        stopCameraBtn.disabled = false;
        
        updateStatus('success', 'Camera started successfully! Position yourself in the frame and click capture.');
    } catch (error) {
        console.error('Error accessing camera:', error);
        updateStatus('danger', 'Error accessing camera. Please check camera permissions.');
    }
});

// Stop Camera
stopCameraBtn.addEventListener('click', function() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        
        startCameraBtn.disabled = false;
        captureBtn.disabled = true;
        stopCameraBtn.disabled = true;
        
        updateStatus('info', 'Camera stopped. Click "Start Camera" to begin again.');
        hideRecognitionResults();
    }
});

// Capture and Process Image
captureBtn.addEventListener('click', function() {
    // Set canvas dimensions to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert canvas to base64 image
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show processing status
    updateStatus('warning', 'Processing image... Please wait.');
    captureBtn.disabled = true;
    
    // Send image to server for recognition
    fetch('/mark_attendance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image: imageData })
    })
    .then(response => response.json())
    .then(data => {
        captureBtn.disabled = false;
        
        if (data.success) {
            updateStatus('success', data.message);
            showRecognitionResults(data.students || []);
            loadAttendanceSummary(); // Refresh the summary
        } else {
            updateStatus('danger', data.message);
            hideRecognitionResults();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        updateStatus('danger', 'Error processing image. Please try again.');
        captureBtn.disabled = false;
        hideRecognitionResults();
    });
});

function updateStatus(type, message) {
    statusMessage.className = `alert alert-${type}`;
    statusMessage.innerHTML = `<i class="fas fa-${getIconClass(type)} me-2"></i>${message}`;
}

function getIconClass(type) {
    switch(type) {
        case 'success': return 'check-circle';
        case 'danger': return 'exclamation-circle';
        case 'warning': return 'clock';
        default: return 'info';
    }
}

function showRecognitionResults(students) {
    if (students.length > 0) {
        let resultsHtml = '';
        students.forEach(student => {
            const badgeClass = student.status === 'Attendance marked' ? 'success' : 'warning';
            resultsHtml += `
                <div class="mb-2 p-2 border rounded">
                    <strong>${student.name}</strong><br>
                    <small>Roll: ${student.roll_number}</small><br>
                    <span class="badge bg-${badgeClass}">${student.status}</span>
                </div>
            `;
        });
        resultsList.innerHTML = resultsHtml;
        recognitionResults.style.display = 'block';
    } else {
        hideRecognitionResults();
    }
}

function hideRecognitionResults() {
    recognitionResults.style.display = 'none';
}

// Load attendance summary on page load
function loadAttendanceSummary() {
    fetch('/reports')
    .then(response => response.text())
    .then(html => {
        // This is a simple way to get today's stats
        // In a real application, you might want a dedicated API endpoint
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Update summary (this is a simplified version)
        // You could enhance this by creating a dedicated API endpoint
    })
    .catch(error => {
        console.error('Error loading summary:', error);
    });
}

// Load summary on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAttendanceSummary();
});
</script>
{% endblock %}
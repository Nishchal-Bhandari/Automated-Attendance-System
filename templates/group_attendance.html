{% extends "base.html" %}

{% block title %}Group Photo Attendance - Student Attendance System{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <!-- Header Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-camera me-2"></i>Group Photo Attendance
                    </h3>
                    <p class="mb-0 mt-2">Take one photo of the entire class - the system will automatically identify all students!</p>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 class="text-primary">{{ total_students }}</h4>
                            <p class="mb-0">Total Students</p>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-success">{{ present_today }}</h4>
                            <p class="mb-0">Present Today</p>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-warning">{{ total_students - present_today }}</h4>
                            <p class="mb-0">Not Yet Marked</p>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-info">{{ ((present_today / total_students) * 100)|round|int if total_students > 0 else 0 }}%</h4>
                            <p class="mb-0">Attendance Rate</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <!-- Camera Section -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-video me-2"></i>Class Photo Camera
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Camera View -->
                            <div class="text-center">
                                <video id="video" width="100%" height="400" autoplay style="border-radius: 10px; background-color: #f8f9fa; max-width: 640px;">
                                    Your browser does not support video streaming.
                                </video>
                                
                                <!-- Canvas for capturing images (hidden) -->
                                <canvas id="canvas" style="display: none;"></canvas>
                                
                                <!-- Camera Controls -->
                                <div class="mt-3">
                                    <button id="startCamera" class="btn btn-primary me-2">
                                        <i class="fas fa-play me-2"></i>Start Camera
                                    </button>
                                    <button id="captureBtn" class="btn btn-success me-2" disabled>
                                        <i class="fas fa-camera me-2"></i>Take Class Photo
                                    </button>
                                    <button id="stopCamera" class="btn btn-danger" disabled>
                                        <i class="fas fa-stop me-2"></i>Stop Camera
                                    </button>
                                </div>
                                
                                <!-- Processing Indicator -->
                                <div id="processingIndicator" class="mt-3" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Processing...</span>
                                    </div>
                                    <p class="mt-2">Processing group photo... Please wait.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instructions Card -->
                    <div class="card mt-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>How to Use Group Photo Attendance
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-users text-success me-2"></i>Before Taking Photo:</h6>
                                    <ul class="small">
                                        <li>Arrange students so all faces are visible</li>
                                        <li>Ensure good lighting in the classroom</li>
                                        <li>Students should face the camera</li>
                                        <li>Remove sunglasses, caps if possible</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-camera text-primary me-2"></i>Taking the Photo:</h6>
                                    <ul class="small">
                                        <li>Click "Take Class Photo" when ready</li>
                                        <li>System will identify all students automatically</li>
                                        <li>Check results and mark any missed students</li>
                                        <li>Takes only 2-3 seconds to process</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Status Panel -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Status & Results
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="statusMessage" class="alert alert-info">
                                <i class="fas fa-info me-2"></i>Click "Start Camera" to begin group photo attendance
                            </div>
                            
                            <!-- Recognition Results -->
                            <div id="recognitionResults" style="display: none;">
                                <h6><i class="fas fa-check-circle me-2 text-success"></i>Photo Results:</h6>
                                <div id="summaryStats" class="mb-3"></div>
                                <div id="studentsList" class="max-height-300 overflow-auto"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card mt-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-tools me-2"></i>Quick Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('manual_attendance_for_missed') }}" class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-user-check me-2"></i>Mark Missed Students
                                </a>
                                <a href="{{ url_for('reports') }}" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-chart-bar me-2"></i>View Today's Report
                                </a>
                                <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-redo me-2"></i>Take Another Photo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Photos -->
                    {% if recent_photos %}
                    <div class="card mt-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-history me-2"></i>Today's Photos
                            </h6>
                        </div>
                        <div class="card-body">
                            {% for photo in recent_photos %}
                            <div class="mb-2 p-2 border rounded small">
                                <strong>{{ photo.time_taken.strftime('%I:%M %p') }}</strong><br>
                                <span class="text-success">{{ photo.students_detected }} students detected</span><br>
                                <span class="text-muted">{{ photo.total_faces_found }} total faces</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.max-height-300 {
    max-height: 300px;
}
.overflow-auto {
    overflow-y: auto;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let context = canvas.getContext('2d');
let stream = null;

const startCameraBtn = document.getElementById('startCamera');
const captureBtn = document.getElementById('captureBtn');
const stopCameraBtn = document.getElementById('stopCamera');
const statusMessage = document.getElementById('statusMessage');
const recognitionResults = document.getElementById('recognitionResults');
const processingIndicator = document.getElementById('processingIndicator');
const summaryStats = document.getElementById('summaryStats');
const studentsList = document.getElementById('studentsList');

// Start Camera
startCameraBtn.addEventListener('click', async function() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        video.srcObject = stream;
        
        startCameraBtn.disabled = true;
        captureBtn.disabled = false;
        stopCameraBtn.disabled = false;
        
        updateStatus('success', 'Camera started! Arrange students so all faces are visible, then click "Take Class Photo".');
    } catch (error) {
        console.error('Error accessing camera:', error);
        updateStatus('danger', 'Error accessing camera. Please check camera permissions and try again.');
    }
});

// Stop Camera
stopCameraBtn.addEventListener('click', function() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        
        startCameraBtn.disabled = false;
        captureBtn.disabled = true;
        stopCameraBtn.disabled = true;
        
        updateStatus('info', 'Camera stopped. Click "Start Camera" to begin again.');
        hideRecognitionResults();
    }
});

// Capture Group Photo and Process
captureBtn.addEventListener('click', function() {
    // Set canvas dimensions to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert canvas to base64 image
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show processing indicator
    processingIndicator.style.display = 'block';
    updateStatus('warning', 'Processing group photo... This may take a few seconds depending on class size.');
    captureBtn.disabled = true;
    
    // Send image to server for group processing
    fetch('/process_group_photo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image: imageData })
    })
    .then(response => response.json())
    .then(data => {
        processingIndicator.style.display = 'none';
        captureBtn.disabled = false;
        
        if (data.success) {
            updateStatus('success', data.message);
            showGroupResults(data);
        } else {
            updateStatus('danger', data.message);
            hideRecognitionResults();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        processingIndicator.style.display = 'none';
        updateStatus('danger', 'Error processing group photo. Please try again.');
        captureBtn.disabled = false;
        hideRecognitionResults();
    });
});

function updateStatus(type, message) {
    statusMessage.className = `alert alert-${type}`;
    statusMessage.innerHTML = `<i class="fas fa-${getIconClass(type)} me-2"></i>${message}`;
}

function getIconClass(type) {
    switch(type) {
        case 'success': return 'check-circle';
        case 'danger': return 'exclamation-circle';
        case 'warning': return 'clock';
        default: return 'info';
    }
}

function showGroupResults(data) {
    const summary = data.summary;
    const students = data.recognized_students || [];
    
    // Show summary statistics
    summaryStats.innerHTML = `
        <div class="row text-center small">
            <div class="col-6">
                <div class="bg-success text-white p-2 rounded mb-2">
                    <strong>${summary.students_recognized}</strong><br>
                    <small>New Attendance</small>
                </div>
            </div>
            <div class="col-6">
                <div class="bg-info text-white p-2 rounded mb-2">
                    <strong>${summary.total_faces_found}</strong><br>
                    <small>Faces Found</small>
                </div>
            </div>
        </div>
        ${summary.already_marked > 0 ? `<div class="alert alert-warning small mb-2">
            <i class="fas fa-info-circle me-1"></i>
            ${summary.already_marked} student(s) already marked today
        </div>` : ''}
        ${summary.unrecognized_faces > 0 ? `<div class="alert alert-warning small mb-2">
            <i class="fas fa-exclamation-triangle me-1"></i>
            ${summary.unrecognized_faces} face(s) not recognized
        </div>` : ''}
        <div class="text-muted small">
            <i class="fas fa-clock me-1"></i>Processed in ${summary.processing_time}s
        </div>
    `;
    
    // Show recognized students
    if (students.length > 0) {
        let studentsHtml = '<h6 class="mt-3"><i class="fas fa-users me-2"></i>Recognized Students:</h6>';
        students.forEach(student => {
            const badgeClass = student.status === 'Attendance marked' ? 'success' : 'secondary';
            const icon = student.status === 'Attendance marked' ? 'check' : 'info';
            studentsHtml += `
                <div class="mb-2 p-2 border rounded small">
                    <strong>${student.name}</strong><br>
                    <small class="text-muted">Roll: ${student.roll_number}</small><br>
                    <span class="badge bg-${badgeClass}">
                        <i class="fas fa-${icon} me-1"></i>${student.status}
                    </span>
                    <small class="text-muted d-block">Confidence: ${student.confidence}%</small>
                </div>
            `;
        });
        studentsList.innerHTML = studentsHtml;
    } else {
        studentsList.innerHTML = '<p class="text-muted small">No students recognized in this photo.</p>';
    }
    
    recognitionResults.style.display = 'block';
    
    // Show warnings if any
    if (data.warnings && data.warnings.length > 0) {
        data.warnings.forEach(warning => {
            setTimeout(() => {
                alert('⚠️ ' + warning);
            }, 1000);
        });
    }
}

function hideRecognitionResults() {
    recognitionResults.style.display = 'none';
}

// Auto-refresh attendance stats every 30 seconds
setInterval(function() {
    fetch('/group_attendance')
    .then(response => response.text())
    .then(html => {
        // Update stats without refreshing entire page
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        // Could update specific elements here
    })
    .catch(error => {
        console.log('Auto-refresh failed:', error);
    });
}, 30000);
</script>
{% endblock %}